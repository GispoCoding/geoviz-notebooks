{% extends 'layout.html' %}

{% block content %}
    <div class="container">
        <h4>{{title}}</h1>
        {% if running %}
            <p>Import and analysis is running at the moment. You may still start a new analysis, but running
            multiple imports and analyses at the same time will slow down processing, and may crash current
            analysis if too many large datasets are processed simultaneously.
            
            This page does not update automatically, please reload the page or come back later to check if
            processing is finished.</p>
        {% endif %}
        {% if analyses %}
            <div class="analysis-list">
                {% for analysis in analyses %}
                    <div class="row analysis">
                        <hr>
                        <div class="col s9">
                            <div class="col s7">
                                {{ analysis.name }}
                            </div>
                            <div class="col s2">
                                {% if not analysis.finish_time %}
                                    <div class="progress right">
                                        <div class="indeterminate"></div>
                                    </div>
                                {% else %}
                                    Finished
                                {% endif %}
                            </div>
                            {% if analysis.finish_time %}
                                <div class="col s5 left-align">
                                    Started at {{ analysis.start_time }}
                                </div>
                                <div class="col s4 right-align">
                                    Finished at {{ analysis.finish_time }}
                                </div>
                            {% else %}
                                <div class="col s7">
                                    Started at {{ analysis.start_time }}
                                </div>
                                <div class="col s2 right-align">
                                    Running...
                                </div>
                            {% endif %}
                        </div>
                        <div class="col s3">
                            {% if not analysis.finish_time %}
                                <button class="waves-effect waves-light btn right">
                                    <i class="material-icons left">cancel</i>Cancel
                                </button>
                            {% else %}
                                <button class="waves-effect waves-light btn right">
                                    View results
                                </button>
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        <hr>
        <p>{{description}}</p>
        <div class="form-wrapper">
      
            <form id="import_form" method="POST" action="{{ url_for('home') }}">
                {{ form.csrf_token }}
                <div class="row">
                    <div class="col m12 l5">
                        <fieldset class="form-field">
                            {{ form.dataset_selection.label }}
                            {{ form.dataset_selection }}
                            {% for error in form.dataset_selection.errors %}
                                <div class="card-panel red lighten-2">
                                    <span class="white-text">{{ error }}</span>
                                </div>
                            {% endfor %}
                        </fieldset>
            
                        <fieldset class="form-field">
                            {{ form.flickr_apikey.label }}
                            {{ form.flickr_apikey }}
                        </fieldset>
            
                        <fieldset class="form-field">
                            {{ form.mapbox_apikey.label }}
                            {{ form.mapbox_apikey }}
                        </fieldset>
                        <fieldset class="form-field">
                            {{ form.gtfs_url.label }}
                            {{ form.gtfs_url }}
                            {% for error in form.gtfs_url.errors %}
                                <div class="card-panel red lighten-2">
                                    <span class="white-text">{{ error }}</span>
                                </div>
                            {% endfor %}
                        </fieldset>
                    </div>
                    <div class="col m12 l7">
                        <fieldset class="form-field">
                            {{ form.bbox.csrf_token }}
                            {{ form.bbox.map }}
                            {{ form.bbox.city.label }}
                            {{ form.bbox.city(autocomplete="off") }}
                            {% for error in form.bbox.city.errors %}
                                <div class="card-panel red lighten-2">
                                    <span class="white-text">{{ error }}</span>
                                </div>
                            {% endfor %}
                            {{ form.bbox.bbox.label }}
                            {{ form.bbox.bbox(readonly=true) }}
                        </fieldset>
                    </div>
                </div>
      
                {{ form.import_button(class="waves-effect waves-light btn")}}
      
            </form>
          </div>
    </div>
{% endblock %}